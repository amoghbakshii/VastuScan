<% layout('layouts/boilerplate') %>

<!-- Mapbox CSS -->
<link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
<script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>

<style>
  
  * {
    font-family: 'DM Serif Display', serif;
  }

  .btn-edit {
    background-color: #06202B;
    color: #F5EEDD;
    padding: 8px 16px;
    border: none;
    border-radius: 6px;
    text-decoration: none;
    margin-right: 10px;
    transition: 0.3s;
  }

  .btn-edit:hover {
    background-color: #0d3344;
  }

  .btn-delete {
    background-color: #E63946;
    color: white;
    padding: 8px 16px;
    border: none;
    border-radius: 6px;
    transition: 0.3s;
  }

  .btn-delete:hover {
    background-color: #c92b38;
  }

  .card.border-left-info {
    border-left: 5px solid #17a2b8;
    background-color: #f8f9fa;
    border-radius: 12px;
    transition: 0.3s;
  }

  .card.border-left-info:hover {
    box-shadow: 0 0 12px rgba(0, 0, 0, 0.08);
    transform: translateY(-2px);
  }

  /* Flex layout for listings + appointments */
  .flex-layout {
    display: flex;
    flex-wrap: wrap;
    gap: 2rem;
  }

  .business-section,
  .appointment-section {
    flex: 1 1 100%;
  }

  @media (min-width: 992px) {
    .business-section,
    .appointment-section {
      flex: 1 1 48%;
    }
  }

  /* Timeline styles */
  .timeline {
    position: relative;
    padding-left: 20px;
    margin-top: 1rem;
  }

  .timeline::before {
    content: '';
    position: absolute;
    top: 0;
    bottom: 0;
    left: 6px;
    width: 2px;
    background: #17a2b8;
  }

  .timeline-step {
    position: relative;
    padding-left: 20px;
    margin-bottom: 10px;
  }

  .timeline-step::before {
    content: '';
    position: absolute;
    left: -4px;
    top: 3px;
    width: 10px;
    height: 10px;
    background-color: #17a2b8;
    border-radius: 50%;
  }

  @keyframes fadeInUp {
  from {
    opacity: 0;
    transform: translateY(10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

@keyframes slideFadeIn {
  0% {
    opacity: 0;
    transform: translateX(-10px);
  }
  100% {
    opacity: 1;
    transform: translateX(0);
  }
}

@keyframes bounceHover {
  0%, 100% {
    transform: scale(1);
  }
  50% {
    transform: scale(1.05);
  }
}

.card {
  animation: fadeInUp 0.6s ease forwards;
  opacity: 0;
}

.card:nth-of-type(1) { animation-delay: 0.1s; }
.card:nth-of-type(2) { animation-delay: 0.2s; }
.card:nth-of-type(3) { animation-delay: 0.3s; }
/* keep going if you want more stagger */

.btn-edit,
.btn-delete {
  transition: transform 0.3s ease, background-color 0.3s ease;
}

.btn-edit:hover,
.btn-delete:hover {
  animation: bounceHover 0.3s ease;
}

.timeline-step {
  animation: slideFadeIn 0.4s ease;
  opacity: 0;
}

.timeline-step:nth-child(1) {
  animation-delay: 0.1s;
  animation-fill-mode: forwards;
}

.timeline-step:nth-child(2) {
  animation-delay: 0.2s;
  animation-fill-mode: forwards;
}

.timeline-step:nth-child(3) {
  animation-delay: 0.3s;
  animation-fill-mode: forwards;
}

</style>

<div class="container my-5">
  <h1 id="greeting" class="mb-4">Dashboard</h1>

  <div class="flex-layout">
    <!-- BUSINESS LISTINGS -->
    <div class="business-section">
      <h3>Your Listings</h3>
      <% if (businesses.length === 0) { %>
        <p>No businesses listed yet. <a href="/business/list-business">Click here to list one!</a></p>
      <% } else { %>
        <% businesses.forEach((business, index) => { %>
          <div class="card shadow-sm mb-4">
            <div class="card-body">
              <h4 class="card-title"><%= business.name %></h4>
              <h6 class="card-subtitle mb-2 text-muted"><%= business.serviceType %></h6>
              <p><strong>Address:</strong> <%= business.address %></p>
              <p><strong>Contact:</strong> <%= business.contact %></p>
              <p><strong>Description:</strong> <%= business.description || 'N/A' %></p>

              <div id="map<%= index %>" style="height: 200px;" class="my-3 rounded shadow-sm"></div>

              <p class="text-muted">
                <small>Listed on: <%= business.createdAt ? business.createdAt.toDateString() : 'Unknown date' %></small>
              </p>

              <div class="mt-3">
                <a href="/business/edit/<%= business._id %>" class="btn-edit">Edit</a>
                <form action="/business/delete/<%= business._id %>" method="POST" style="display: inline;">
                  <button type="submit" class="btn-delete" onclick="return confirm('Are you sure you want to delete this listing?')">Delete</button>
                </form>
              </div>
            </div>
          </div>

          <!-- Mapbox Init Script -->
          <script>
            mapboxgl.accessToken = '<%= process.env.MAPBOX_TOKEN %>';

            const map<%= index %> = new mapboxgl.Map({
              container: 'map<%= index %>',
              style: 'mapbox://styles/mapbox/streets-v11',
              center: [<%= business.location.coordinates[0] %>, <%= business.location.coordinates[1] %>],
              zoom: 12
            });

            new mapboxgl.Marker()
              .setLngLat([<%= business.location.coordinates[0] %>, <%= business.location.coordinates[1] %>])
              .addTo(map<%= index %>);
          </script>
        <% }) %>
      <% } %>
    </div>

    <!-- UPCOMING APPOINTMENTS -->
    <div class="appointment-section">
      <h3>Upcoming Appointments</h3>
      <% if (!appointments || appointments.length === 0) { %>
        <p>No appointments yet, chill time ðŸ˜Ž</p>
      <% } else { %>
        <% appointments.forEach(appt => { %>
          <div class="card border-left-info shadow mb-4 py-2 px-3">
            <div class="card-body">
              <h4 class="card-title mb-2"><%= appt.userRefName %> - <%= appt.phone %> </h4>
              <p><strong>Service - </strong> <%= appt.serviceType %></p>
              <p><strong>Date - </strong> <%= new Date(appt.date).toLocaleDateString() %></p>
              <p><strong>Time - </strong> <%= appt.time %></p>
              <p><strong>Business - </strong> <%= appt.business.name %></p>
              <% if (appt.message) { %>
                <p><strong>Customer Message - <br></strong> <%= appt.message %></p>
              <% } %>

              <!-- Status Timeline -->
              <div class="timeline">
                <div class="timeline-step"><strong>Status - </strong> Requested</div>
                <% if (appt.status === 'Confirmed' || appt.status === 'Completed') { %>
                  <div class="timeline-step">Confirmed</div>
                <% } %>
                <% if (appt.status === 'Completed') { %>
                  <div class="timeline-step">Completed</div>
                <% } %>
                <% if (appt.status === 'Cancelled') { %>
                  <div class="timeline-step text-danger">Cancelled</div>

                  
                <% } %>
              </div>
            </div>
          </div>
        <% }) %>
      <% } %>
    </div>
  </div>
</div>


<h1 id="greeting" class="mb-4"></h1>

<script>
  const hours = new Date().getHours();
  let greeting = "";

  if (hours < 12) {
    greeting = "Good Morning";
  } else if (hours < 17) {
    greeting = "Good Afternoon";
  } else {
    greeting = "Good Evening";
  }

  const userName = "<%= userName %>";
  document.getElementById("greeting").textContent = `${greeting}, ${userName} `;
</script>